name: CICD

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Generate secrets YAML from GitHub Secrets
      env:
        MARIADB_ROOT_PASSWORD: ${{ secrets.MARIADB_PASSWORD }}
        MARIADB_DATABASE: ${{ secrets.MARIADB_DATABASE }}
        MARIADB_USER: ${{ secrets.MARIADB_USER }}
        MARIADB_PASSWORD: ${{ secrets.MARIADB_PASSWORD }}
      run: |
        set -e
        
        # Créer le dossier k8s
        mkdir -p PaulineSoubrieWordpress
        
        # Fonction pour encoder en base64
        encode_base64() {
          echo -n "$1" | base64
        }
        
        # Générer le fichier yaml des secrets
        cat > PaulineSoubrieWordpress/secrets.yaml <<EOF
        ---
        apiVersion: v1
        kind: Secret
        metadata:
          name: mariadb-root-password
        type: Opaque
        data:
          mariadb_root_password: $(encode_base64 "$MARIADB_ROOT_PASSWORD")
        ---
        apiVersion: v1
        kind: Secret
        metadata:
          name: mariadb-database
        type: Opaque
        data:
          mariadb_database: $(encode_base64 "$MARIADB_DATABASE")
        ---
        apiVersion: v1
        kind: Secret
        metadata:
          name: mariadb-user
        type: Opaque
        data:
          mariadb_user: $(encode_base64 "$MARIADB_USER")
        ---
        apiVersion: v1
        kind: Secret
        metadata:
          name: mariadb-password
        type: Opaque
        data:
          mariadb_password: $(encode_base64 "$MARIADB_PASSWORD")
        EOF

        echo "Fichier secrets.yaml généré avec succès"
    
    - name: Install Kompose
      run: |
        curl -L https://github.com/kubernetes/kompose/releases/download/v1.38.0/kompose-linux-amd64 -o kompose
        chmod +x kompose
        sudo mv kompose /usr/local/bin/kompose
    - name: Convert docker-compose to Kubernetes manifests
      run: |
        kompose convert -f docker-compose.yml -o PaulineSoubrieWordpress/
    
    - name: Fix deployments to use secrets
      run: |
        # Installer PyYAML pour modifier les YAML
        pip3 install pyyaml --quiet
        
        # Script Python pour corriger les déploiements
        python3 <<'PYEOF'
        import yaml
        import sys
        
        # Corriger mariadb-deployment.yaml
        with open('PaulineSoubrieWordpress/mariadb-deployment.yaml', 'r') as f:
            mariadb_doc = yaml.safe_load(f)
        
        container = mariadb_doc['spec']['template']['spec']['containers'][0]
        env_vars = container.get('env', [])
        
        # Mapping des variables aux secrets
        secret_mapping = {
            'MARIADB_ROOT_PASSWORD': {'secret': 'mariadb-root-password', 'key': 'mariadb_root_password'},
            'MARIADB_DATABASE': {'secret': 'mariadb-database', 'key': 'mariadb_database'},
            'MARIADB_USER': {'secret': 'mariadb-user', 'key': 'mariadb_user'},
            'MARIADB_PASSWORD': {'secret': 'mariadb-password', 'key': 'mariadb_password'}
        }
        
        # Remplacer les variables d'environnement vides par des références aux secrets
        new_env = []
        for var in env_vars:
            var_name = var.get('name', '')
            if var_name in secret_mapping:
                mapping = secret_mapping[var_name]
                new_env.append({
                    'name': var_name,
                    'valueFrom': {
                        'secretKeyRef': {
                            'name': mapping['secret'],
                            'key': mapping['key']
                        }
                    }
                })
            else:
                new_env.append(var)
        
        container['env'] = new_env
        
        with open('PaulineSoubrieWordpress/mariadb-deployment.yaml', 'w') as f:
            yaml.dump(mariadb_doc, f, default_flow_style=False, sort_keys=False, allow_unicode=True)
        
        # Corriger wordpress-deployment.yaml si il existe
        try:
            with open('PaulineSoubrieWordpress/wordpress-deployment.yaml', 'r') as f:
                wp_doc = yaml.safe_load(f)
            
            wp_container = wp_doc['spec']['template']['spec']['containers'][0]
            wp_env_vars = wp_container.get('env', [])
            
            wp_secret_mapping = {
                'WORDPRESS_DB_NAME': {'secret': 'mariadb-database', 'key': 'mariadb_database'},
                'WORDPRESS_DB_USER': {'secret': 'mariadb-user', 'key': 'mariadb_user'},
                'WORDPRESS_DB_PASSWORD': {'secret': 'mariadb-password', 'key': 'mariadb_password'}
            }
            
            new_wp_env = []
            for var in wp_env_vars:
                var_name = var.get('name', '')
                if var_name in wp_secret_mapping:
                    mapping = wp_secret_mapping[var_name]
                    new_wp_env.append({
                        'name': var_name,
                        'valueFrom': {
                            'secretKeyRef': {
                                'name': mapping['secret'],
                                'key': mapping['key']
                            }
                        }
                    })
                else:
                    new_wp_env.append(var)
            
            wp_container['env'] = new_wp_env
            
            with open('PaulineSoubrieWordpress/wordpress-deployment.yaml', 'w') as f:
                yaml.dump(wp_doc, f, default_flow_style=False, sort_keys=False, allow_unicode=True)
        except FileNotFoundError:
            pass
        
        print("✅ Déploiements corrigés pour utiliser les secrets")
        PYEOF
    
    - name: Zip Kubernetes YAML files
      run: |
        zip -r PaulineSoubrieWordpress.zip PaulineSoubrieWordpress/

    - name: Install lftp
      run: sudo apt-get update && sudo apt-get install -y lftp

    - name: Upload zip to FTP
      env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          FTP_PATH: ${{ secrets.FTP_PATH }}
      run: |
        lftp -u "$FTP_USER","$FTP_PASSWORD" "$FTP_HOST" <<EOF
        set ssl:verify-certificate no
        cd $FTP_PATH
        put PaulineSoubrieWordpress.zip
        bye
        EOF
